<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Loan Recovery & AI Automation Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e3e8ee;
        }

        .card h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Enhanced Filter Section */
        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Customer display controls styling */
        #customerDisplayLimit {
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        #customerDisplayLimit:hover {
            border-color: #0056b3 !important;
            background-color: #f8f9fa !important;
        }

        #customerDisplayLimit:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25) !important;
        }

        #selectedCustomersInfo {
            animation: pulse 0.3s ease when updated;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Pagination dropdown specific styles */

        /* Serial number column styling */
        .csv-table th:nth-child(2),
        .csv-table td:nth-child(2) {
            text-align: center;
            font-weight: 600;
            background-color: #f8f9fa;
            border-right: 2px solid #dee2e6;
        }

        .csv-table th:nth-child(2) {
            background-color: #e9ecef;
            color: #495057;
        }

        /* CSV Data Table Styles */
        .csv-data-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e3e8ee;
        }

        .csv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .csv-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #5a67d8;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .csv-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .csv-table tr:hover {
            background-color: #f8f9fa;
        }

        .csv-table tr:nth-child(even) {
            background-color: #fafbfc;
        }

        /* Status Badge Styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-ready { background: #d4edda; color: #155724; }
        .status-calling { background: #fff3cd; color: #856404; }
        .status-in-progress { background: #cce5ff; color: #004085; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-agent-transfer { background: #e2e3e5; color: #383d41; }

        /* Upload Date Badge */
        .upload-date-badge {
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
        }

        .date-today { background: #e8f5e8; color: #2e7d32; }
        .date-yesterday { background: #fff8e1; color: #f57f17; }
        .date-week { background: #e3f2fd; color: #1565c0; }
        .date-older { background: #fce4ec; color: #c2185b; }
        .date-future { background: #f3e5f5; color: #7b1fa2; }

        /* Action Buttons */
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            margin: 2px;
            transition: all 0.3s ease;
        }

        .btn-call {
            background: #28a745;
            color: white;
        }

        .btn-call:hover {
            background: #218838;
        }

        .btn-status {
            background: #17a2b8;
            color: white;
        }

        .btn-status:hover {
            background: #138496;
        }

        .btn-details {
            background: #6c757d;
            color: white;
        }

        .btn-details:hover {
            background: #5a6268;
        }

        /* Bulk Actions */
        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .bulk-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bulk-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .bulk-btn-primary {
            background: #007bff;
            color: white;
        }

        .bulk-btn-success {
            background: #28a745;
            color: white;
        }

        .bulk-btn-warning {
            background: #ffc107;
            color: #212529;
        }

        /* Statistics Grid */
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background-color: #f0f4ff;
        }

        .upload-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
        }

        /* Session Management Styles */
        .user-session-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e3e8ee;
        }

        .logout-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .logout-button:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .session-timer {
            color: #666;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .session-timer.warning {
            color: #ffc107;
            font-weight: 600;
        }

        .session-timer.critical {
            color: #dc3545;
            font-weight: 600;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .session-expired-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .session-expired-modal {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .session-expired-modal h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .session-expired-modal p {
            margin-bottom: 20px;
            color: #666;
        }

        .session-expired-modal button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        /* Customer Details Modal */
        .customer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Table Container with Scroll */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e3e8ee;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .statistics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .csv-table {
                font-size: 11px;
            }
            
            .csv-table th, .csv-table td {
                padding: 6px 4px;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Global Loading Overlay */
        .global-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .global-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .global-loader {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2em;
            color: #333;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 0.9em;
            color: #666;
            text-align: center;
            max-width: 300px;
        }

        /* Enhanced Loading States */
        .card.loading {
            position: relative;
            overflow: hidden;
        }

        .card.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
            animation: shimmer 1.5s infinite;
        }

        .section-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }

        .section-loader .loading {
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Progress Bar */
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #17a2b8;
        }

        .toast.warning {
            background: #ffc107;
            color: #212529;
        }

        /* Batch Details Section */
        .batch-details-container {
            margin-top: 20px;
        }

        .batch-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .batch-stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .batch-stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .batch-stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .batch-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .batch-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .batch-table-header h4 {
            margin: 0;
            color: #333;
        }

        .batch-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .batch-btn {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .batch-btn:hover {
            background: #0056b3;
        }

        .batch-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .batch-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .batch-pagination-info {
            color: #666;
            font-size: 14px;
        }

        .batch-pagination-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Call Status Tracking Styles */
        .call-status-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .call-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .call-status-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .call-stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #28a745;
        }

        .call-stat-card:nth-child(2) {
            border-left-color: #ffc107;
        }

        .call-stat-card:nth-child(3) {
            border-left-color: #28a745;
        }

        .call-stat-card:nth-child(4) {
            border-left-color: #dc3545;
        }

        .call-stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .call-stat-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .call-status-actions {
            display: flex;
            gap: 10px;
        }

        .refresh-button, .auto-refresh-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .refresh-button:hover, .auto-refresh-button:hover {
            background: #5a6fd8;
        }

        .auto-refresh-button.active {
            background: #28a745;
        }

        .call-status-table-container {
            overflow-x: auto;
        }

        .call-status-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .call-status-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }

        .call-status-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .call-status-table tr:hover {
            background-color: #f8f9fa;
        }

        .call-status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-initiated { background: #e3f2fd; color: #1976d2; }
        .status-call_in_progress { background: #fff3e0; color: #f57c00; }
        .status-call_completed { background: #e8f5e8; color: #2e7d32; }
        .status-call_failed { background: #ffebee; color: #c62828; }
        .status-ringing { background: #f3e5f5; color: #7b1fa2; }

        /* Call Details Modal Styles */
        .call-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .call-info p {
            margin: 5px 0;
        }

        .status-timeline {
            max-height: 400px;
            overflow-y: auto;
        }

        .status-timeline-item {
            display: flex;
            gap: 15px;
            padding: 10px;
            border-left: 3px solid #e9ecef;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .status-timestamp {
            flex-shrink: 0;
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
            width: 120px;
        }

        .status-info {
            flex-grow: 1;
        }

        .status-message {
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }

        .call-actions {
            display: flex;
            gap: 5px;
        }

        .call-action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s;
        }

        .call-action-btn:hover {
            background: #5a6fd8;
        }

        .refresh-batch-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .refresh-batch-btn:hover {
            background: #5a6fd8;
        }

        .batch-table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .batch-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .batch-table th {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .batch-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .batch-table tbody tr:hover {
            background: #f8f9fa;
        }

        .loading-row {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .batch-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            text-transform: uppercase;
        }

        .batch-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .batch-status.processing {
            background: #fff3cd;
            color: #856404;
        }

        .batch-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .batch-status.pending {
            background: #d1ecf1;
            color: #0c5460;
        }

        .batch-success-rate {
            font-weight: 600;
        }

        .batch-success-rate.high {
            color: #28a745;
        }

        .batch-success-rate.medium {
            color: #ffc107;
        }

        .batch-success-rate.low {
            color: #dc3545;
        }

        .batch-actions {
            display: flex;
            gap: 5px;
        }

        .batch-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: opacity 0.3s ease;
        }

        .batch-action-btn:hover {
            opacity: 0.8;
        }

        .batch-action-btn.view {
            background: #17a2b8;
            color: white;
        }

        .batch-action-btn.download {
            background: #28a745;
            color: white;
        }

        .batch-action-btn.delete {
            background: #dc3545;
            color: white;
        }

        /* Responsive design for batch section */
        @media (max-width: 768px) {
            .batch-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .batch-table-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .batch-table {
                font-size: 0.8em;
            }
            
            .batch-table th,
            .batch-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>

        </style>
    </head>
    <body>

    <div class="header">
        <h1>ÔøΩ Bank Loan Recovery & AI Automation Dashboard</h1>
        <p>Enterprise-Grade Loan Recovery Management with AI-Powered Automation</p>
        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
            <span id="lastStatusUpdate">Last update: Never</span> | 
            <span id="statusRefreshCount">Refreshes: 0</span> |
            <span id="totalCustomersDisplay">Total: 0</span>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div class="global-loading-overlay" id="globalLoadingOverlay">
        <div class="global-loader"></div>
        <div class="loading-text" id="loadingText">Loading Dashboard...</div>
        <div class="loading-subtext" id="loadingSubtext">Please wait while we fetch your data</div>
    </div>

    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <!-- User Session Info -->
    <div class="user-session-info" id="userSessionInfo" style="display: none;">
        <span id="userDisplayName">User</span>
        <span class="session-timer" id="sessionTimer">2:00:00</span>
        <button class="logout-button" onclick="handleLogout()">Logout</button>
    </div>

    <!-- Session Expired Modal -->
    <div class="session-expired-overlay" id="sessionExpiredOverlay" style="display: none;">
        <div class="session-expired-modal">
            <h3>üïí Session Expired</h3>
            <p>Your session has expired for security reasons. Please log in again to continue.</p>
            <button onclick="redirectToLogin()">Login Again</button>
        </div>
    </div>

    <div class="container">
        <!-- Statistics Overview -->
        <div class="statistics-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCustomersStat">0</div>
                <div class="stat-label">Loan Portfolio Overview</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayUploadsStat">0</div>
                <div class="stat-label">Daily Data Imports</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="readyToCallStat">0</div>
                <div class="stat-label">Recovery Eligible Accounts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCallsStat">0</div>
                <div class="stat-label">Active Recovery Processes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCallsStat">0</div>
                <div class="stat-label">Daily Recovery Completions</div>
            </div>
        </div>

        <!-- Quick Upload Section -->
        <div class="card">
            <h3>üìÅ Portfolio Data Management Dashboard</h3>
            <div class="upload-section" id="uploadArea">
                <p>üìÑ Drag & drop CSV file here or click to browse</p>
                <p style="font-size: 0.9em; color: #666; margin: 10px 0;">
                    Expected format: name, phone, loan_id, amount, due_date, state, Cluster, Branch, etc.
                </p>
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose CSV File
                </button>
            </div>
            <div id="uploadStatus" class="log-entry"></div>
            <div id="uploadProgress" class="progress-container" style="display: none;">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>
        </div>

        <!-- Batch Upload Details Section -->
        <div class="card">
            <h3>üìä Data Import Analytics & History</h3>
            <div class="batch-details-container">
                <div class="batch-stats-grid">
                    <div class="batch-stat-card">
                        <div class="batch-stat-number" id="totalBatchesStat">0</div>
                        <div class="batch-stat-label">Total Batches</div>
                    </div>
                    <div class="batch-stat-card">
                        <div class="batch-stat-number" id="todayBatchesStat">0</div>
                        <div class="batch-stat-label">Today's Batches</div>
                    </div>
                    <div class="batch-stat-card">
                        <div class="batch-stat-number" id="totalRecordsStat">0</div>
                        <div class="batch-stat-label">Total Records</div>
                    </div>
                    <div class="batch-stat-card">
                        <div class="batch-stat-number" id="successRateStat">0%</div>
                        <div class="batch-stat-label">Success Rate</div>
                    </div>
                </div>
                <div class="batch-table-container">
                    <div class="batch-table-header">
                        <h4>üìÑ Recent File Uploads</h4>
                        <div class="batch-controls">
                            <select id="batchDateFilter" class="filter-select">
                                <option value="today">Today</option>
                                <option value="week">Past Week</option>
                                <option value="month">Past Month</option>
                                <option value="">All Time</option>
                            </select>
                            <select id="batchPageSize" class="filter-select">
                                <option value="10">10 per page</option>
                                <option value="20">20 per page</option>
                                <option value="25" selected>25 per page</option>
                                <option value="30">30 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                                <option value="all">All</option>
                            </select>
                            <button class="batch-btn" id="selectAllBatchBtn">Select All Filtered</button>
                            <button class="refresh-batch-btn" onclick="loadBatchDetails()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div class="batch-table-wrapper">
                        <table class="batch-table" id="batchTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="batchSelectAllPage" title="Select all on this page">
                                    </th>
                                    <th>File Name</th>
                                    <th>Upload Date</th>
                                    <th>Total Records</th>
                                    <th>Success Rate</th>
                                    <th>Status</th>
                                    <th>Uploaded By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="batchTableBody">
                                <tr>
                                    <td colspan="8" class="loading-row">Loading batch data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="batch-pagination">
                        <div class="batch-pagination-info">
                            <span id="batchPaginationInfo">Showing 0 - 0 of 0 uploads</span>
                        </div>
                        <div class="batch-pagination-controls">
                            <button class="batch-btn" id="batchPrevBtn" disabled>‚Üê Previous</button>
                            <span id="batchCurrentPageInfo">Page 1 of 1</span>
                            <button class="batch-btn" id="batchNextBtn" disabled>Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Call Status Tracking Section
        <div class="card">
            <h3>üìû Call Status Tracking</h3>
            <div class="call-status-container">
                <div class="call-status-header">
                    <div class="call-status-stats">
                        <div class="call-stat-card">
                            <div class="call-stat-number" id="totalCallsStat">0</div>
                            <div class="call-stat-label">Total Calls</div>
                        </div>
                        <div class="call-stat-card">
                            <div class="call-stat-number" id="inProgressCallsStat">0</div>
                            <div class="call-stat-label">In Progress</div>
                        </div>
                        <div class="call-stat-card">
                            <div class="call-stat-number" id="completedCallsStat">0</div>
                            <div class="call-stat-label">Completed</div>
                        </div>
                        <div class="call-stat-card">
                            <div class="call-stat-number" id="failedCallsStat">0</div>
                            <div class="call-stat-label">Failed</div>
                        </div>
                    </div>
                    <div class="call-status-actions">
                        <button class="refresh-button" onclick="loadCallStatuses()">üîÑ Refresh</button>
                        <button class="auto-refresh-button" onclick="toggleAutoRefresh()">
                            <span id="autoRefreshText">‚ñ∂Ô∏è Auto Refresh</span>
                        </button>
                    </div>
                </div>
                
                <div class="call-status-table-container">
                    <table class="call-status-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Call SID</th>
                                <th>Status</th>
                                <th>Message</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="callStatusTableBody">
                            <tr>
                                <td colspan="7" class="loading-row">Loading call status data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div> -->

        <!-- Enhanced Filter Section -->
        <div class="card">
            <h3>üîç Customer Portfolio Search & Filters</h3>
            <div class="filter-section">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">üîç Search</label>
                        <input type="text" class="filter-input" id="searchInput" 
                               placeholder="Search by name, phone, loan ID...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üìÖ Upload Date</label>
                        <select class="filter-select" id="uploadDateFilter">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="this-week">This Week</option>
                            <option value="last-week">Last Week</option>
                            <option value="this-month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="filter-group" id="customDateRange" style="display: none;">
                        <label class="filter-label">üìÖ Date Range</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="date" class="filter-input" id="startDate">
                            <input type="date" class="filter-input" id="endDate">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ÔøΩ Call Status</label>
                        <select class="filter-select" id="callStatusFilter">
                            <option value="">All Statuses</option>
                            <option value="ready">Ready</option>
                            <option value="calling">Calling</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="agent-transfer">Agent Transfer</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üåç State</label>
                        <select class="filter-select" id="stateFilter">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üè¢ Cluster</label>
                        <select class="filter-select" id="clusterFilter">
                            <option value="">All Clusters</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üè™ Branch</label>
                        <select class="filter-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üë§ Employee</label>
                        <select class="filter-select" id="employeeFilter">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                </div>
                
                <div class="bulk-actions">
                    <span class="selected-count" id="selectedCount">0 selected</span>
                    <button class="bulk-btn bulk-btn-primary" id="refreshDataBtn">
                        üîÑ Refresh Data
                    </button>
                    <button class="bulk-btn" id="selectAllFilteredBtn">
                        ‚úÖ Select All Filtered
                    </button>
                    <button class="bulk-btn bulk-btn-success" id="callSelectedBtn" disabled>
                        üìû Call Selected (<span id="selectedCountText">0</span>)
                    </button>
                    <button class="bulk-btn bulk-btn-warning" id="updateSelectedStatusBtn" disabled>
                        üìä Update Status
                    </button>
                    <button class="bulk-btn" id="exportSelectedBtn" disabled>
                        üì• Export Selected
                    </button>
                    <button class="bulk-btn" id="clearFiltersBtn">
                        üóëÔ∏è Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Customer Data Table in CSV Format -->
        <div class="card">
            <h3>üë• Customer Loan Accounts</h3>
            
            <!-- Dynamic Pagination Status -->
            <div id="paginationStatus" style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; font-weight: 500;">
                <div>
                    <span id="currentViewInfo">üìä Currently viewing records 1-20 of 49 total</span>
                </div>
                <div>
                    <span id="serialRangeInfo">üî¢ Serial No. 1 to 20</span>
                    <button class="bulk-btn bulk-btn-primary" onclick="loadCustomerData(true)" style="margin-left: auto; padding: 4px 8px; font-size: 0.8em;">
                        üîÑ Refresh Now
                    </button>
                </div>
            </div>
            
            <!-- <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #28a745;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: #28a745; font-weight: 600;">üü¢ Live Database Connection</span>
                       Data automatically synced from PostgreSQL database every 5 minutes
                    </span>
                    <button class="bulk-btn bulk-btn-primary" onclick="loadCustomerData(true)" style="margin-left: auto; padding: 4px 8px; font-size: 0.8em;">
                        üîÑ Refresh Now
                    </button>
                </div>
            </div> -->

            <!-- Customer Display Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-weight: 600; color: #495057;">Show:</label>
                        <select id="customerDisplayLimit" class="filter-select" style="width: auto; min-width: 80px; padding: 8px 12px; border: 2px solid #007bff; border-radius: 6px; background-color: white; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="all">All</option>
                        </select>
                        <span style="font-weight: 500; color: #495057;">customers</span>
                    </div>
                    <div style="height: 20px; width: 1px; background: #dee2e6;"></div>
                    <button class="bulk-btn bulk-btn-primary" id="selectAllDisplayedBtn" style="padding: 8px 12px; font-size: 0.9em;">
                        ‚òëÔ∏è Select All Displayed
                    </button>
                    <button class="bulk-btn bulk-btn-warning" id="deselectAllBtn" style="padding: 8px 12px; font-size: 0.9em;">
                        ‚ùå Deselect All
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="displayedCustomersInfo" style="font-weight: 600; color: #495057;">
                        Showing 0 of 0 customers
                    </span>
                    <span id="selectedCustomersInfo" style="font-weight: 600; color: #007bff; background: #e3f2fd; padding: 4px 8px; border-radius: 4px;">
                        0 selected
                    </span>
                </div>
            </div>
            <div class="csv-data-container">
                <div class="table-container">
                    <table class="csv-table" id="customerTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th style="width: 60px;">S.No.</th>
                                <th>Upload Date</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Loan ID</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>State</th>
                                <th>Cluster</th>
                                <th>Branch</th>
                                <th>Branch Contact</th>
                                <th>Employee</th>
                                <th>Employee ID</th>
                                <th>Employee Contact</th>
                                <th>Last Paid Date</th>
                                <th>Last Paid Amount</th>
                                <th>Due Amount</th>
                                <th>Call Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <tr>
                                <td colspan="19" style="text-align: center; padding: 40px; color: #666;">
                                    <div class="loading"></div>
                                    <div style="margin-top: 10px;">Loading customer data...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Real-time Call Status -->
        <div class="card">
            <h3>üîÑ Recovery Operations & Communication Monitoring</h3>
            <div id="callStatusContainer">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <div class="stat-number" id="activeCallsCount">0</div>
                        <div class="stat-label">Active Calls</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <div class="stat-number" id="queuedCallsCount">0</div>
                        <div class="stat-label">Queued Calls</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #17a2b8;">
                        <div class="stat-number" id="completedTodayCount">0</div>
                        <div class="stat-label">Completed Today</div>
                    </div>
                </div>
                <div id="activityLog" style="background: #f8f9fa; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <div style="color: #666; text-align: center; padding: 20px;">
                        No recent activity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="customer-modal" id="customerModal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <h3>üë§ Customer Details</h3>
            <div id="customerDetailsContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
    // Global variables
    let customers = [];
    let filteredCustomers = [];
    let displayedCustomers = [];
    let selectedCustomers = new Set();

    // Session management variables
    let sessionData = null;
    let sessionCheckInterval = null;
    let sessionWarningShown = false;

    // Batch upload pagination variables
        let batchCurrentPage = 1;
        let batchPageSize = 25;  // Default to 25 per page
        let batchDateFilter = 'today';
        let selectedBatchIds = new Set();
        let ws = null;
        let refreshInterval = null;
        let autoRefreshInterval = null;
        let dataRefreshInterval = null;
        let isInitialLoad = true;

        // Auto-refresh settings
        const AUTO_REFRESH_INTERVAL = 30000; // 30 seconds
        const DATA_REFRESH_INTERVAL = 60000;  // 1 minute for full data refresh

        // Simple IST date formatting functions
        function formatDateIST(dateString, options = {}) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                
                const defaultOptions = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    ...options
                };
                
                return date.toLocaleString('en-IN', defaultOptions) + ' IST';
            } catch (error) {
                console.warn('Error formatting date:', error);
                return dateString;
            }
        }

        function formatTimeIST(dateString) {
            return formatDateIST(dateString, {
                year: undefined,
                month: undefined,
                day: undefined
            }).replace(' IST', '') + ' IST';
        }

        function formatDateOnlyIST(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-IN');
            } catch (error) {
                return dateString;
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard initializing...');
            showGlobalLoading('Initializing Dashboard...', 'Setting up connection and loading data...');
            
            // Initialize session management first
            initializeSessionManagement();
            // Initialize dashboard after session management
            initializeDashboard();
        });

        // === SESSION MANAGEMENT FUNCTIONS ===
        
        async function initializeSessionManagement() {
            console.log('üîê Initializing session management...');
            
            try {
                // Check initial session status
                await checkSessionStatus();
                
                // Start session monitoring
                startSessionMonitoring();
                
                console.log('‚úÖ Session management initialized');
            } catch (error) {
                console.error('‚ùå Session management initialization failed:', error);
            }
        }
        
        async function checkSessionStatus() {
            try {
                const response = await fetch('/auth/session-status');
                const data = await response.json();
                
                if (data.authenticated) {
                    sessionData = data;
                    updateSessionDisplay(data);
                } else {
                    handleSessionExpired();
                }
                
                return data;
            } catch (error) {
                console.error('Error checking session status:', error);
                return { authenticated: false, expired: true };
            }
        }
        
        function updateSessionDisplay(data) {
            const userSessionInfo = document.getElementById('userSessionInfo');
            const userDisplayName = document.getElementById('userDisplayName');
            const sessionTimer = document.getElementById('sessionTimer');
            
            if (data.authenticated && data.user) {
                userDisplayName.textContent = data.user.name || data.user.email;
                updateSessionTimer(data.remaining_time);
                userSessionInfo.style.display = 'block';
            } else {
                userSessionInfo.style.display = 'none';
            }
        }
        
        function updateSessionTimer(remainingSeconds) {
            const sessionTimer = document.getElementById('sessionTimer');
            
            if (remainingSeconds <= 0) {
                sessionTimer.textContent = 'Expired';
                sessionTimer.className = 'session-timer critical';
                handleSessionExpired();
                return;
            }
            
            const hours = Math.floor(remainingSeconds / 3600);
            const minutes = Math.floor((remainingSeconds % 3600) / 60);
            const seconds = remainingSeconds % 60;
            
            const timeString = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            sessionTimer.textContent = timeString;
            
            // Change color based on remaining time
            if (remainingSeconds <= 300) { // 5 minutes
                sessionTimer.className = 'session-timer critical';
                if (!sessionWarningShown) {
                    showSessionWarning(remainingSeconds);
                    sessionWarningShown = true;
                }
            } else if (remainingSeconds <= 600) { // 10 minutes
                sessionTimer.className = 'session-timer warning';
            } else {
                sessionTimer.className = 'session-timer';
            }
        }
        
        function startSessionMonitoring() {
            // Check session status every 30 seconds
            sessionCheckInterval = setInterval(async () => {
                const status = await checkSessionStatus();
                if (!status.authenticated) {
                    stopSessionMonitoring();
                    handleSessionExpired();
                }
            }, 30000);
            
            // Update timer every second
            setInterval(() => {
                if (sessionData && sessionData.remaining_time > 0) {
                    sessionData.remaining_time--;
                    updateSessionTimer(sessionData.remaining_time);
                }
            }, 1000);
        }
        
        function stopSessionMonitoring() {
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
                sessionCheckInterval = null;
            }
        }
        
        function showSessionWarning(remainingSeconds) {
            const minutes = Math.ceil(remainingSeconds / 60);
            showToast(`‚ö†Ô∏è Session expires in ${minutes} minute${minutes > 1 ? 's' : ''}! Please save your work.`, 'warning', 10000);
        }
        
        function handleSessionExpired() {
            console.log('üïí Session expired - showing modal');
            
            // Stop monitoring
            stopSessionMonitoring();
            
            // Show expired modal
            document.getElementById('sessionExpiredOverlay').style.display = 'flex';
            
            // Hide session info
            document.getElementById('userSessionInfo').style.display = 'none';
        }
        
        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }
            
            console.log('üö™ Logout initiated by user');
            
            try {
                // Show loading
                showGlobalLoading('Logging out...', 'Please wait while we securely log you out');
                
                // Call logout API
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Stop session monitoring
                    stopSessionMonitoring();
                    
                    // Redirect to Cognito logout
                    window.location.href = data.logout_url;
                } else {
                    throw new Error(data.message || 'Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                hideGlobalLoading();
                showToast('‚ùå Logout failed. Please try again.', 'error');
            }
        }
        
        function redirectToLogin() {
            window.location.href = '/login';
        }

        async function initializeDashboard() {
            try {
                // Step 1: Initialize WebSocket
                updateLoadingText('Connecting to server...', 'Establishing real-time connection...');
                initializeWebSocket();
                
                // Step 2: Initialize event listeners
                updateLoadingText('Setting up interface...', 'Preparing dashboard controls...');
                initializeEventListeners();
                
                // Step 3: Load initial data
                updateLoadingText('Loading customer data...', 'Fetching latest customer information...');
                await loadCustomerData(false, true); // Pass true for initial load
                
                // Step 4: Load batch data
                updateLoadingText('Loading batch history...', 'Fetching upload analytics...');
                
                // Set default batch filter to today and page size to 25
                const batchSizeDropdown = document.getElementById('batchPageSize');
                if (document.getElementById('batchDateFilter')) {
                    document.getElementById('batchDateFilter').value = 'today';
                    batchDateFilter = 'today';
                }
                if (batchSizeDropdown) {
                    batchSizeDropdown.value = '25';
                    const selectedSize = batchSizeDropdown.value;
                    batchPageSize = selectedSize === 'all' ? 'all' : parseInt(selectedSize, 10);
                }
                
                await loadBatchDetails(true);
                
                // Step 5: Load call statuses
                updateLoadingText('Loading call status...', 'Fetching communication records...');
                await loadCallStatuses(true);
                
                // Step 6: Setup auto-refresh
                updateLoadingText('Finalizing setup...', 'Enabling real-time updates...');
                setupAutoRefresh();
                setupHotReloading();
                
                // Step 7: Hide loading overlay
                setTimeout(() => {
                    hideGlobalLoading();
                    showToast('Dashboard loaded successfully!', 'success');
                    console.log('‚úÖ Dashboard initialization complete');
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Dashboard initialization failed:', error);
                updateLoadingText('Loading failed', `Error: ${error.message}`);
                
                setTimeout(() => {
                    hideGlobalLoading();
                    showToast('Failed to load dashboard. Please refresh the page.', 'error', 5000);
                }, 1000);
            }
        }

        // WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/enhanced`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateConnectionStatus('connected');
                logActivity('WebSocket connected successfully');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                updateConnectionStatus('disconnected');
                logActivity('WebSocket disconnected, attempting to reconnect...');
                setTimeout(initializeWebSocket, 3000);
            };
            
            ws.onerror = function() {
                updateConnectionStatus('error');
                logActivity('WebSocket connection error');
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.event) {
                case 'call_status_update':
                    updateCustomerCallStatus(data.customer_id, data.status, data.message);
                    break;
                case 'upload_progress':
                    updateUploadProgress(data.progress, data.message);
                    break;
                case 'upload_complete':
                    // Refresh customer data when upload completes
                    logActivity('üìä Upload completed, refreshing customer data...');
                    setTimeout(() => loadCustomerData(true), 1000);
                    break;
                case 'bulk_operation_update':
                    updateBulkOperationStatus(data);
                    break;
                case 'data_update':
                    // Generic data update event
                    logActivity('üìä Data updated, refreshing customer list...');
                    loadCustomerData(false);
                    break;
                default:
                    console.log('Unknown WebSocket event:', data);
            }
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // File upload
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload();
                }
            });

            // Filter controls
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('uploadDateFilter').addEventListener('change', handleDateFilterChange);
            document.getElementById('callStatusFilter').addEventListener('change', applyFilters);
            document.getElementById('stateFilter').addEventListener('change', applyFilters);
            document.getElementById('clusterFilter').addEventListener('change', applyFilters);
            document.getElementById('branchFilter').addEventListener('change', applyFilters);
            document.getElementById('employeeFilter').addEventListener('change', applyFilters);
            document.getElementById('startDate').addEventListener('change', applyFilters);
            document.getElementById('endDate').addEventListener('change', applyFilters);

            // Customer display controls
            document.getElementById('customerDisplayLimit').addEventListener('change', function() {
                // Visual feedback
                this.style.backgroundColor = '#e3f2fd';
                setTimeout(() => { this.style.backgroundColor = 'white'; }, 300);
                
                renderCustomerTable();
                updateDisplayInfo();
                showToast(`Displaying ${this.value === 'all' ? 'all' : this.value} customers`, 'info');
            });

            document.getElementById('selectAllDisplayedBtn').addEventListener('click', selectAllDisplayedCustomers);
            document.getElementById('deselectAllBtn').addEventListener('click', deselectAllCustomers);

            // Bulk action buttons
            document.getElementById('refreshDataBtn').addEventListener('click', () => loadCustomerData(true));
            document.getElementById('selectAllFilteredBtn').addEventListener('click', selectAllFilteredCustomers);
            document.getElementById('callSelectedBtn').addEventListener('click', callSelectedCustomers);
            document.getElementById('updateSelectedStatusBtn').addEventListener('click', updateSelectedStatus);
            document.getElementById('exportSelectedBtn').addEventListener('click', exportSelectedCustomers);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);

            // Select all checkbox
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#customerTableBody input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    if (this.checked) {
                        selectedCustomers.add(cb.value);
                    } else {
                        selectedCustomers.delete(cb.value);
                    }
                });
                updateSelectionCount();
            });

            // Modal close
            document.getElementById('modalClose').addEventListener('click', function() {
                document.getElementById('customerModal').style.display = 'none';
            });

            // Batch upload controls
            document.getElementById('batchDateFilter').addEventListener('change', function() {
                batchDateFilter = this.value;
                batchCurrentPage = 1;
                loadBatchDetails();
            });

            document.getElementById('batchPageSize').addEventListener('change', function() {
                batchPageSize = this.value === 'all' ? 'all' : parseInt(this.value);
                batchCurrentPage = 1;
                loadBatchDetails();
            });

            document.getElementById('selectAllBatchBtn').addEventListener('click', selectAllFilteredUploads);

            document.getElementById('batchPrevBtn').addEventListener('click', function() {
                if (batchCurrentPage > 1) {
                    batchCurrentPage--;
                    loadBatchDetails();
                }
            });

            document.getElementById('batchNextBtn').addEventListener('click', function() {
                batchCurrentPage++;
                loadBatchDetails();
            });

            // Batch select all checkbox for current page
            document.getElementById('batchSelectAllPage').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.batch-row-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    const batchId = cb.getAttribute('data-batch-id');
                    if (this.checked) {
                        selectedBatchIds.add(batchId);
                    } else {
                        selectedBatchIds.delete(batchId);
                    }
                });
                updateBatchSelectAllState();
            });

            // Individual batch row checkbox handlers (delegated)
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('batch-row-checkbox')) {
                    const batchId = e.target.getAttribute('data-batch-id');
                    if (e.target.checked) {
                        selectedBatchIds.add(batchId);
                    } else {
                        selectedBatchIds.delete(batchId);
                    }
                    updateBatchSelectAllState();
                }
            });
        }

        // Handle date filter changes
        function handleDateFilterChange() {
            const dateFilter = document.getElementById('uploadDateFilter').value;
            const customDateRange = document.getElementById('customDateRange');
            
            if (dateFilter === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
            
            applyFilters();
        }

        // Load customer data from database with enhanced error handling
        async function loadCustomerData(forceRefresh = false, isInitialLoad = false) {
            try {
                if (!isInitialLoad) {
                    showLoading(true);
                }
                
                if (forceRefresh) {
                    logActivity('üîÑ Force refreshing customer data from database...');
                } else if (isInitialLoad) {
                    console.log('üìä Initial load: Loading customer data from database...');
                } else {
                    logActivity('üìä Loading customer data from database...');
                }
                
                // Add cache-busting parameter to ensure fresh data
                const cacheBuster = `?_t=${Date.now()}`;
                let response;
                
                try {
                    response = await fetch(`/api/customers${cacheBuster}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                } catch (fetchError) {
                    // If API is not available, provide empty data for now
                    console.warn('API not available, using empty data:', fetchError);
                    customers = [];
                    filteredCustomers = [];
                    selectedCustomers.clear();
                    updateSelectionCount();
                    populateFilterOptions();
                    applyFilters();
                    updateStatistics();
                    
                    if (!isInitialLoad) {
                        logActivity('‚ö†Ô∏è API not available - using empty data');
                    }
                    return;
                }
                
                if (!response.ok) {
                    // Handle HTTP errors gracefully
                    if (response.status === 404) {
                        console.warn('API endpoint not found, using empty data');
                        customers = [];
                        filteredCustomers = [];
                        selectedCustomers.clear();
                        updateSelectionCount();
                        populateFilterOptions();
                        applyFilters();
                        updateStatistics();
                        
                        if (!isInitialLoad) {
                            logActivity('‚ö†Ô∏è API endpoint not found - using empty data');
                        }
                        return;
                    }
                    throw new Error(`Failed to fetch customers: ${response.status} ${response.statusText}`);
                }
                
                const responseData = await response.json();
                
                // Ensure we have an array of customers
                if (!Array.isArray(responseData)) {
                    throw new Error('Invalid response format: expected array of customers');
                }
                
                // Normalize customer data - ensure each customer has a loans array
                customers = responseData.map(customer => ({
                    ...customer,
                    loans: Array.isArray(customer.loans) ? customer.loans : []
                }));
                
                // Debug upload date fields for first few customers
                if (customers.length > 0) {
                    console.log('üóÇÔ∏è Upload date field analysis:');
                    customers.slice(0, 3).forEach((customer, index) => {
                        console.log(`Customer ${index + 1}:`, {
                            id: customer.id,
                            name: customer.full_name || customer.name || 'Unknown',
                            first_uploaded_at: customer.first_uploaded_at,
                            created_at: customer.created_at,
                            updated_at: customer.updated_at
                        });
                    });
                }
                
                filteredCustomers = [...customers];
                
                // Clear any existing selections since data has been refreshed
                selectedCustomers.clear();
                updateSelectionCount();
                
                populateFilterOptions();
                applyFilters();
                updateStatistics();
                
                const timestamp = getCurrentISTTime();
                logActivity(`‚úÖ Successfully loaded ${customers.length} customers from database at ${timestamp} IST`);
                
                // Show success toast for manual refreshes
                if (forceRefresh) {
                    showToast(`Data refreshed: ${customers.length} customers loaded`, 'success');
                }
                
                // Update last refresh time in header
                document.getElementById('lastStatusUpdate').textContent = `Last update: ${timestamp} IST`;
                
                // Increment refresh counter
                const refreshCountEl = document.getElementById('statusRefreshCount');
                const currentCount = parseInt(refreshCountEl.textContent.split(': ')[1]) || 0;
                refreshCountEl.textContent = `Refreshes: ${currentCount + 1}`;
                
            } catch (error) {
                console.error('Error loading customers:', error);
                const errorMessage = `Failed to load customer data: ${error.message}`;
                
                if (!isInitialLoad) {
                    logActivity(`‚ùå ${errorMessage}`, 'error');
                    showToast(errorMessage, 'error');
                }
                
                // Show error in table if no data is available
                if (customers.length === 0) {
                    const tbody = document.getElementById('customerTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="19" style="text-align: center; padding: 40px; color: #dc3545;">
                                    <div style="margin-bottom: 10px;">‚ö†Ô∏è Error loading customer data</div>
                                    <div style="font-size: 0.9em;">${error.message}</div>
                                    <button class="bulk-btn bulk-btn-primary" onclick="loadCustomerData(true)" style="margin-top: 15px;">
                                        üîÑ Retry
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                }
                
                // Re-throw error for initial load to be handled by initialization
                if (isInitialLoad) {
                    throw error;
                }
                
            } finally {
                if (!isInitialLoad) {
                    showLoading(false);
                }
            }
        }

        // Load batch details from database
        async function loadBatchDetails(isInitialLoad = false) {
            try {
                if (!isInitialLoad) {
                    logActivity('üìä Loading batch upload details...');
                } else {
                    console.log('üìä Initial load: Loading batch upload details...');
                }
                
                // Ensure variables are properly initialized
                if (typeof batchCurrentPage === 'undefined') batchCurrentPage = 1;
                if (typeof batchPageSize === 'undefined') batchPageSize = 25;
                if (typeof batchDateFilter === 'undefined') batchDateFilter = 'today';
                
                // Build query parameters
                const params = new URLSearchParams({
                    page: batchCurrentPage,
                    page_size: batchPageSize === 'all' ? 1000 : batchPageSize  // Use large number for "all"
                });
                
                if (batchDateFilter) {
                    params.append('date_filter', batchDateFilter);
                }
                
                console.log('üìä Loading batch details with params:', {
                    page: batchCurrentPage,
                    page_size: batchPageSize,
                    date_filter: batchDateFilter,
                    url: `/api/uploaded-files?${params}`
                });
                
                const response = await fetch(`/api/uploaded-files?${params}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log('üìä Batch details response:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('üìä Batch details error response:', errorText);
                    
                    // Try to parse the error response for better debugging
                    let errorMessage = `Failed to fetch batch data: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.detail) {
                            errorMessage += `. Details: ${errorData.detail}`;
                        }
                        if (errorData.path) {
                            errorMessage += ` (Path: ${errorData.path})`;
                        }
                    } catch (e) {
                        // If we can't parse as JSON, just use the text
                        if (errorText) {
                            errorMessage += `. Response: ${errorText.substring(0, 200)}`;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const responseData = await response.json();
                console.log('üìä Batch details data:', responseData);
                
                // Handle simple array response format from API
                let batches = [];
                let pagination = {};
                
                if (Array.isArray(responseData)) {
                    // Direct array response - apply client-side pagination
                    const allBatches = responseData;
                    
                    // Apply date filter with IST timezone support
                    let filteredBatches = allBatches;
                    if (batchDateFilter && batchDateFilter !== 'all') {
                        // Get current IST date for comparison
                        const nowIST = new Date().toLocaleString('en-US', {timeZone: 'Asia/Kolkata'});
                        const today = new Date(nowIST);
                        const todayStr = today.toDateString();
                        const yesterdayStr = new Date(today.getTime() - 86400000).toDateString();
                        
                        console.log('üìä Date filter debug:', {
                            filter: batchDateFilter,
                            todayIST: todayStr,
                            yesterdayIST: yesterdayStr
                        });
                        
                        filteredBatches = allBatches.filter(batch => {
                            // Convert batch date to IST for comparison
                            const batchDateUTC = new Date(batch.uploaded_at);
                            const batchDateIST = new Date(batchDateUTC.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));
                            const batchDateStr = batchDateIST.toDateString();
                            
                            console.log('üìä Batch date comparison:', {
                                filename: batch.filename,
                                originalDate: batch.uploaded_at,
                                batchDateIST: batchDateStr,
                                todayIST: todayStr,
                                matches: batchDateStr === todayStr
                            });
                            
                            switch (batchDateFilter) {
                                case 'today': return batchDateStr === todayStr;
                                case 'yesterday': return batchDateStr === yesterdayStr;
                                case 'week': 
                                    const weekAgo = new Date(today.getTime() - 7 * 86400000);
                                    return batchDateIST >= weekAgo;
                                case 'month':
                                    const monthAgo = new Date(today.getTime() - 30 * 86400000);
                                    return batchDateIST >= monthAgo;
                                default: return true;
                            }
                        });
                        
                        console.log('üìä Filtered batches:', {
                            total: allBatches.length,
                            filtered: filteredBatches.length,
                            filter: batchDateFilter
                        });
                    }
                    
                    // Apply pagination
                    const totalCount = filteredBatches.length;
                    const pageSize = batchPageSize === 'all' ? totalCount : parseInt(batchPageSize);
                    const totalPages = Math.ceil(totalCount / pageSize);
                    const startIndex = (batchCurrentPage - 1) * pageSize;
                    const endIndex = startIndex + pageSize;
                    
                    batches = filteredBatches.slice(startIndex, endIndex);
                    pagination = {
                        current_page: batchCurrentPage,
                        page_size: pageSize,
                        total_count: totalCount,
                        total_pages: totalPages,
                        has_prev: batchCurrentPage > 1,
                        has_next: batchCurrentPage < totalPages
                    };
                } else {
                    // Structured response format
                    if (!responseData.success) {
                        throw new Error(responseData.error || 'Failed to load batch data');
                    }
                    batches = responseData.uploads || [];
                    pagination = responseData.pagination || {};
                }
                
                // Update batch statistics
                updateBatchStatistics(batches, pagination);
                
                // Populate batch table
                populateBatchTable(batches);
                
                // Update pagination controls
                updateBatchPagination(pagination);
                
                logActivity(`‚úÖ Successfully loaded ${batches.length} batch uploads (page ${pagination.current_page} of ${pagination.total_pages})`);
                
            } catch (error) {
                console.error('Error loading batch details:', error);
                logActivity(`‚ùå Failed to load batch details: ${error.message}`, 'error');
                
                // Show error in batch table
                const tbody = document.getElementById('batchTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #dc3545;">
                            <div>‚ö†Ô∏è Error loading batch data: ${error.message}</div>
                            <button class="refresh-batch-btn" onclick="loadBatchDetails()" style="margin-top: 10px;">
                                üîÑ Retry
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        // Update batch statistics
        function updateBatchStatistics(batches, pagination) {
            const today = new Date().toDateString();
            
            // Calculate statistics from current page
            const totalBatches = pagination.total_count || 0;
            const todayBatches = batches.filter(batch => {
                const batchDate = new Date(batch.uploaded_at).toDateString();
                return batchDate === today;
            }).length;
            
            const totalRecords = batches.reduce((sum, batch) => sum + (batch.total_records || 0), 0);
            const totalSuccess = batches.reduce((sum, batch) => sum + (batch.success_records || 0), 0);
            const successRate = totalRecords > 0 ? Math.round((totalSuccess / totalRecords) * 100) : 0;
            
            // Update DOM elements
            document.getElementById('totalBatchesStat').textContent = totalBatches;
            document.getElementById('todayBatchesStat').textContent = todayBatches;
            document.getElementById('totalRecordsStat').textContent = totalRecords.toLocaleString();
            document.getElementById('successRateStat').textContent = `${successRate}%`;
        }

        // Populate batch table
        function populateBatchTable(batches) {
            const tbody = document.getElementById('batchTableBody');
            
            if (batches.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                            üìÑ No batch uploads found
                        </td>
                    </tr>
                `;
                return;
            }
            
            const batchRows = batches.map(batch => {
                const uploadDate = new Date(batch.uploaded_at);
                const formattedDate = uploadDate.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const successRate = batch.total_records > 0 
                    ? Math.round((batch.success_records / batch.total_records) * 100)
                    : 0;
                
                const successRateClass = successRate >= 90 ? 'high' : 
                                       successRate >= 70 ? 'medium' : 'low';
                
                const statusClass = batch.status.toLowerCase().replace(' ', '-');
                const isSelected = selectedBatchIds.has(batch.id);
                
                return `
                    <tr data-batch-id="${batch.id}">
                        <td>
                            <input type="checkbox" class="batch-row-checkbox" 
                                   data-batch-id="${batch.id}" 
                                   ${isSelected ? 'checked' : ''}>
                        </td>
                        <td title="${batch.original_filename || batch.filename}">
                            ${truncateText(batch.original_filename || batch.filename, 25)}
                        </td>
                        <td>${formattedDate}</td>
                        <td>${batch.total_records.toLocaleString()}</td>
                        <td>
                            <span class="batch-success-rate ${successRateClass}">
                                ${successRate}% (${batch.success_records}/${batch.total_records})
                            </span>
                        </td>
                        <td>
                            <span class="batch-status ${statusClass}">
                                ${batch.status}
                            </span>
                        </td>
                        <td>${batch.uploaded_by || 'System'}</td>
                        <td>
                            <div class="batch-actions">
                                <button class="batch-action-btn view" onclick="viewBatchDetails('${batch.id}')" title="View Details">
                                    üëÅÔ∏è
                                </button>
                                <button class="batch-action-btn download" onclick="downloadBatchReport('${batch.id}')" title="Download Report">
                                    üíæ
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = batchRows;
            
            // Update select all checkbox state
            updateBatchSelectAllState();
        }

        // Update batch pagination controls
        function updateBatchPagination(pagination) {
            const paginationInfo = document.getElementById('batchPaginationInfo');
            const currentPageInfo = document.getElementById('batchCurrentPageInfo');
            const prevBtn = document.getElementById('batchPrevBtn');
            const nextBtn = document.getElementById('batchNextBtn');
            
            const startRecord = ((pagination.current_page - 1) * pagination.page_size) + 1;
            const endRecord = Math.min(pagination.current_page * pagination.page_size, pagination.total_count);
            
            paginationInfo.textContent = `Showing ${startRecord} - ${endRecord} of ${pagination.total_count} uploads`;
            currentPageInfo.textContent = `Page ${pagination.current_page} of ${pagination.total_pages}`;
            
            prevBtn.disabled = !pagination.has_prev;
            nextBtn.disabled = !pagination.has_next;
        }

        // Update select all checkbox state
        function updateBatchSelectAllState() {
            const selectAllPage = document.getElementById('batchSelectAllPage');
            const rowCheckboxes = document.querySelectorAll('.batch-row-checkbox');
            
            if (rowCheckboxes.length === 0) {
                selectAllPage.checked = false;
                selectAllPage.indeterminate = false;
                return;
            }
            
            const checkedCount = Array.from(rowCheckboxes).filter(cb => cb.checked).length;
            
            if (checkedCount === 0) {
                selectAllPage.checked = false;
                selectAllPage.indeterminate = false;
            } else if (checkedCount === rowCheckboxes.length) {
                selectAllPage.checked = true;
                selectAllPage.indeterminate = false;
            } else {
                selectAllPage.checked = false;
                selectAllPage.indeterminate = true;
            }
        }

        // Select all filtered uploads
        async function selectAllFilteredUploads() {
            try {
                // Build query parameters for current filter
                const params = new URLSearchParams();
                if (batchDateFilter) {
                    params.append('date_filter', batchDateFilter);
                }
                
                const response = await fetch(`/api/uploaded-files/ids?${params}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch upload IDs: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch upload IDs');
                }
                
                // Add all IDs to selection
                data.upload_ids.forEach(id => selectedBatchIds.add(id));
                
                // Update UI
                updateBatchSelectAllState();
                logActivity(`‚úÖ Selected all ${data.upload_ids.length} filtered uploads`);
                
            } catch (error) {
                console.error('Error selecting all uploads:', error);
                logActivity(`‚ùå Failed to select all uploads: ${error.message}`, 'error');
            }
        }

        // View batch details in modal
        async function viewBatchDetails(batchId) {
            try {
                const response = await fetch(`/api/uploaded-files/${batchId}/details`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch batch details: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load batch details');
                }
                
                // Create and show modal with batch details
                showBatchDetailsModal(data.upload_details, data.upload_details.rows);
                
            } catch (error) {
                console.error('Error viewing batch details:', error);
                showToast(`Failed to load batch details: ${error.message}`, 'error');
            }
        }

        // Show batch details modal
        function showBatchDetailsModal(upload, rows) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal(this)">&times;</span>
                    <h3>üìÑ Batch Upload Details</h3>
                    <div class="batch-detail-info">
                        <div><strong>File:</strong> ${upload.original_filename || upload.filename}</div>
                        <div><strong>Uploaded:</strong> ${formatDateIST(upload.uploaded_at)}</div>
                        <div><strong>Status:</strong> <span class="batch-status ${upload.status.toLowerCase()}">${upload.status}</span></div>
                        <div><strong>Total Records:</strong> ${upload.total_records}</div>
                        <div><strong>Success:</strong> ${upload.success_records}</div>
                        <div><strong>Failed:</strong> ${upload.failed_records}</div>
                        ${upload.processing_errors ? `<div><strong>Errors:</strong> <pre>${JSON.stringify(upload.processing_errors, null, 2)}</pre></div>` : ''}
                    </div>
                    ${rows && rows.length > 0 ? `
                        <h4>Sample Records (First 10)</h4>
                        <div class="table-container">
                            <table class="csv-table">
                                <thead>
                                    <tr>
                                        <th>Row #</th>
                                        <th>Customer Name</th>
                                        <th>Phone</th>
                                        <th>Loan ID</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows.slice(0, 10).map((row, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${row.customer_name || 'N/A'}</td>
                                            <td>${row.phone || 'N/A'}</td>
                                            <td>${row.loan_id || 'N/A'}</td>
                                            <td><span class="batch-status ${(row.processing_status || 'unknown').toLowerCase()}">${row.processing_status || 'Unknown'}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        // Download batch report
        function downloadBatchReport(batchId) {
            // Create downloadable CSV report
            const link = document.createElement('a');
            link.href = `/api/uploaded-files/${batchId}/download`;
            link.download = `batch_report_${batchId}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Batch report download started', 'info');
        }

        // Close modal
        function closeModal(element) {
            const modal = element.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // Utility function to truncate text
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength - 3) + '...';
        }

        // === CALL STATUS TRACKING FUNCTIONS ===
        
        let isAutoRefresh = false;

        // Load call statuses from the API
        async function loadCallStatuses(isInitialLoad = false) {
            try {
                if (!isInitialLoad) {
                    logActivity('üìû Loading call status data...');
                } else {
                    console.log('üìû Initial load: Loading call status data...');
                }
                
                const response = await fetch('/api/call-statuses');
                if (!response.ok) {
                    throw new Error(`Failed to fetch call statuses: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load call statuses');
                }
                
                updateCallStatusStats(data.statuses);
                populateCallStatusTable(data.statuses);
                
                logActivity(`‚úÖ Loaded ${data.statuses.length} call status updates`);
                
            } catch (error) {
                console.error('Error loading call statuses:', error);
                logActivity(`‚ùå Failed to load call statuses: ${error.message}`);
                showToast(`Failed to load call statuses: ${error.message}`, 'error');
            }
        }

        // Update call status statistics
        function updateCallStatusStats(statuses) {
            // Group statuses by latest status per call
            const callStatusMap = new Map();
            
            statuses.forEach(status => {
                const existing = callStatusMap.get(status.call_sid);
                if (!existing || new Date(status.timestamp) > new Date(existing.timestamp)) {
                    callStatusMap.set(status.call_sid, status);
                }
            });
            
            const latestStatuses = Array.from(callStatusMap.values());
            
            // Calculate statistics
            const totalCalls = latestStatuses.length;
            const inProgressCalls = latestStatuses.filter(s => 
                s.status === 'call_in_progress' || s.status === 'ringing' || s.status === 'initiated'
            ).length;
            const completedCalls = latestStatuses.filter(s => s.status === 'call_completed').length;
            const failedCalls = latestStatuses.filter(s => s.status === 'call_failed').length;
            
            // Update DOM elements with null checks
            const totalCallsEl = document.getElementById('totalCallsStat');
            const inProgressCallsEl = document.getElementById('inProgressCallsStat');
            const completedCallsEl = document.getElementById('completedCallsStat');
            const failedCallsEl = document.getElementById('failedCallsStat');
            
            if (totalCallsEl) totalCallsEl.textContent = totalCalls;
            if (inProgressCallsEl) inProgressCallsEl.textContent = inProgressCalls;
            if (completedCallsEl) completedCallsEl.textContent = completedCalls;
            if (failedCallsEl) failedCallsEl.textContent = failedCalls;
        }

        // Populate call status table
        function populateCallStatusTable(statuses) {
            const tbody = document.getElementById('callStatusTableBody');
            
            if (!tbody) {
                console.warn('Call status table body element not found');
                return;
            }
            
            if (statuses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                            üìû No call status updates found
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by timestamp descending (newest first)
            const sortedStatuses = statuses.sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            const statusRows = sortedStatuses.slice(0, 50).map(status => {
                const formattedTime = formatDateIST(status.timestamp, {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const statusClass = status.status.toLowerCase().replace(/_/g, '_');
                
                return `
                    <tr>
                        <td title="${status.customer_name}">
                            ${truncateText(status.customer_name, 20)}
                        </td>
                        <td>${status.customer_phone}</td>
                        <td title="${status.call_sid}">
                            ${truncateText(status.call_sid, 15)}
                        </td>
                        <td>
                            <span class="call-status-badge status-${statusClass}">
                                ${status.status.replace(/_/g, ' ')}
                            </span>
                        </td>
                        <td title="${status.message || 'No message'}">
                            ${truncateText(status.message || 'No message', 30)}
                        </td>
                        <td>${formattedTime}</td>
                        <td>
                            <div class="call-actions">
                                <button class="call-action-btn view" onclick="viewCallDetails('${status.call_sid}')" title="View All Updates">
                                    üëÅÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = statusRows;
        }

        // View call details
        async function viewCallDetails(callSid) {
            try {
                const response = await fetch(`/api/call-statuses/${callSid}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch call details: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load call details');
                }
                
                showCallDetailsModal(data);
                
            } catch (error) {
                console.error('Error viewing call details:', error);
                showToast(`Failed to load call details: ${error.message}`, 'error');
            }
        }

        // Show call details modal
        function showCallDetailsModal(callData) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üìû Call Details - ${callData.call_sid}</h3>
                        <button class="modal-close" onclick="closeModal(this)">‚úñÔ∏è</button>
                    </div>
                    <div class="modal-body">
                        <div class="call-info">
                            <p><strong>Customer:</strong> ${callData.customer_name || 'Unknown'}</p>
                            <p><strong>Phone:</strong> ${callData.customer_phone || 'Unknown'}</p>
                            <p><strong>Call SID:</strong> ${callData.call_sid}</p>
                        </div>
                        <h4>Status Updates:</h4>
                        <div class="status-timeline">
                            ${callData.statuses.map(status => {
                                const formattedTime = formatDateIST(status.timestamp);
                                const statusClass = status.status.toLowerCase().replace(/_/g, '_');
                                
                                return `
                                    <div class="status-timeline-item">
                                        <div class="status-timestamp">${formattedTime}</div>
                                        <div class="status-info">
                                            <span class="call-status-badge status-${statusClass}">
                                                ${status.status.replace(/_/g, ' ')}
                                            </span>
                                            <div class="status-message">${status.message || 'No message'}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        // Toggle auto refresh
        function toggleAutoRefresh() {
            const button = document.querySelector('.auto-refresh-button');
            const text = document.getElementById('autoRefreshText');
            
            if (isAutoRefresh) {
                // Stop auto refresh
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                button.classList.remove('active');
                text.textContent = '‚ñ∂Ô∏è Auto Refresh';
                logActivity('‚è∏Ô∏è Auto refresh stopped');
            } else {
                // Start auto refresh
                autoRefreshInterval = setInterval(loadCallStatuses, 10000); // Every 10 seconds
                isAutoRefresh = true;
                button.classList.add('active');
                text.textContent = '‚è∏Ô∏è Stop Auto';
                logActivity('‚ñ∂Ô∏è Auto refresh started (10s interval)');
            }
        }

        // Populate filter dropdown options
        function populateFilterOptions() {
            try {
                // Defensive programming - ensure customers is an array and handle missing loans
                if (!Array.isArray(customers)) {
                    console.warn('Customers data is not an array:', customers);
                    return;
                }
                
                console.log('Populating filter options for', customers.length, 'customers');
                
                const states = [...new Set(customers.map(c => c.state).filter(Boolean))].sort();
                
                // Safely extract loan data with defensive checks
                const clusters = [...new Set(customers.flatMap(c => {
                    if (!c.loans || !Array.isArray(c.loans)) return [];
                    return c.loans.map(l => l.cluster).filter(Boolean);
                }))].sort();
                
                const branches = [...new Set(customers.flatMap(c => {
                    if (!c.loans || !Array.isArray(c.loans)) return [];
                    return c.loans.map(l => l.branch).filter(Boolean);
                }))].sort();
                
                const employees = [...new Set(customers.flatMap(c => {
                    if (!c.loans || !Array.isArray(c.loans)) return [];
                    return c.loans.map(l => l.employee_name).filter(Boolean);
                }))].sort();

                console.log('Filter options:', { states: states.length, clusters: clusters.length, branches: branches.length, employees: employees.length });

                populateSelect('stateFilter', states);
                populateSelect('clusterFilter', clusters);
                populateSelect('branchFilter', branches);
                populateSelect('employeeFilter', employees);
            } catch (error) {
                console.error('Error in populateFilterOptions:', error);
                console.error('Customers data:', customers);
            }
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Keep the "All" option and add new options
            select.innerHTML = select.children[0].outerHTML;
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            // Restore selection if it still exists
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const uploadDateFilter = document.getElementById('uploadDateFilter').value;
            const callStatusFilter = document.getElementById('callStatusFilter').value;
            const stateFilter = document.getElementById('stateFilter').value;
            const clusterFilter = document.getElementById('clusterFilter').value;
            const branchFilter = document.getElementById('branchFilter').value;
            const employeeFilter = document.getElementById('employeeFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredCustomers = customers.filter(customer => {
                // Search filter with enhanced field mapping
                if (searchTerm) {
                    const searchMatch = 
                        (customer.full_name || customer.name || '')?.toLowerCase().includes(searchTerm) ||
                        (customer.primary_phone || customer.phone_number || '').includes(searchTerm) ||
                        customer.loans.some(loan => (loan.loan_id || '').toLowerCase().includes(searchTerm));
                    if (!searchMatch) return false;
                }

                // Upload date filter with enhanced field mapping
                if (uploadDateFilter && uploadDateFilter !== 'custom') {
                    // Get the most appropriate upload date for this customer
                    const primaryUploadDate = customer.first_uploaded_at || customer.created_at;
                    const recentActivityDate = customer.updated_at;
                    
                    // Check both primary upload date AND recent activity for this date
                    const matchesUpload = matchesDateFilter(primaryUploadDate, uploadDateFilter);
                    const matchesActivity = matchesDateFilter(recentActivityDate, uploadDateFilter);
                    
                    // Customer appears in date filter if they were either uploaded OR had recent activity on this date
                    if (!matchesUpload && !matchesActivity) return false;
                }

                // Custom date range filter with enhanced field mapping
                if (uploadDateFilter === 'custom' && (startDate || endDate)) {
                    const primaryUploadDate = customer.first_uploaded_at || customer.created_at;
                    const recentActivityDate = customer.updated_at;
                    
                    let uploadDateString = null;
                    let activityDateString = null;
                    
                    try {
                        if (primaryUploadDate) {
                            uploadDateString = new Date(primaryUploadDate).toISOString().split('T')[0];
                        }
                        if (recentActivityDate) {
                            activityDateString = new Date(recentActivityDate).toISOString().split('T')[0];
                        }
                    } catch (error) {
                        console.warn('Date parsing error for customer', customer.id, error);
                    }
                    
                    // Check if either upload date or activity date falls within the date range
                    const uploadInRange = uploadDateString && ((!startDate || uploadDateString >= startDate) && (!endDate || uploadDateString <= endDate));
                    const activityInRange = activityDateString && ((!startDate || activityDateString >= startDate) && (!endDate || activityDateString <= endDate));
                    
                    if (!uploadInRange && !activityInRange) return false;
                }

                // Call status filter
                if (callStatusFilter) {
                    // Map status values
                    const customerStatus = mapCallStatus(customer.call_status || 'ready');
                    if (customerStatus !== callStatusFilter) return false;
                }

                // State filter
                if (stateFilter && customer.state !== stateFilter) return false;

                // Cluster/Branch/Employee filters (check loans)
                if (clusterFilter || branchFilter || employeeFilter) {
                    // Defensive check for loans array
                    if (!customer.loans || !Array.isArray(customer.loans)) {
                        return false; // If no loans data, doesn't match loan-based filters
                    }
                    
                    const hasMatchingLoan = customer.loans.some(loan => {
                        if (clusterFilter && loan.cluster !== clusterFilter) return false;
                        if (branchFilter && loan.branch !== branchFilter) return false;
                        if (employeeFilter && loan.employee_name !== employeeFilter) return false;
                        return true;
                    });
                    if (!hasMatchingLoan) return false;
                }

                return true;
            });

            renderCustomerTable();
            updateStatistics();
        }

        // Date filter matching with IST timezone support
        function matchesDateFilter(dateString, filter) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Convert to IST for accurate date comparison
            const istDate = new Date(date.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));
            const istToday = new Date(today.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));
            const istYesterday = new Date(yesterday.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));

            switch (filter) {
                case 'today':
                    return istDate.toDateString() === istToday.toDateString();
                case 'yesterday':
                    return istDate.toDateString() === istYesterday.toDateString();
                case 'this-week':
                    const weekStart = new Date(istToday);
                    weekStart.setDate(istToday.getDate() - istToday.getDay());
                    return istDate >= weekStart;
                case 'last-week':
                    const lastWeekStart = new Date(istToday);
                    lastWeekStart.setDate(istToday.getDate() - istToday.getDay() - 7);
                    const lastWeekEnd = new Date(lastWeekStart);
                    lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                    return istDate >= lastWeekStart && istDate <= lastWeekEnd;
                case 'this-month':
                    return istDate.getMonth() === istToday.getMonth() && istDate.getFullYear() === istToday.getFullYear();
                default:
                    return true;
            }
        }

        // Map call status for display
        function mapCallStatus(status) {
            const statusMap = {
                'ready': 'ready',
                'not_initiated': 'ready',
                'calling': 'calling',
                'initiated': 'calling',
                'ringing': 'calling',
                'call_in_progress': 'in-progress',
                'in_progress': 'in-progress',
                'call_completed': 'completed',
                'completed': 'completed',
                'call_failed': 'failed',
                'failed': 'failed',
                'agent_transfer': 'agent-transfer',
                'disconnected': 'failed'
            };
            return statusMap[status] || 'ready';
        }

        // Render customer table
        function renderCustomerTable() {
            const tbody = document.getElementById('customerTableBody');
            
            // Get the display limit from dropdown
            const displayLimit = document.getElementById('customerDisplayLimit').value;
            let pageCustomers;
            
            if (displayLimit === 'all') {
                pageCustomers = filteredCustomers;
            } else {
                const limit = parseInt(displayLimit, 10);
                pageCustomers = filteredCustomers.slice(0, limit);
            }
            
            // Update displayedCustomers for select all functionality
            displayedCustomers = pageCustomers;

            if (pageCustomers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="20" style="text-align: center; padding: 40px; color: #666;">
                            ${filteredCustomers.length === 0 ? 'No customers found' : 'No customers match the current filters'}
                        </td>
                    </tr>
                `;
                updateDisplayInfo();
                return;
            }

            tbody.innerHTML = pageCustomers.map((customer, index) => {
                // Simple serial number (no pagination)
                const serialNo = index + 1;
                
                const loan = customer.loans[0] || {};
                
                // Enhanced upload date handling with multiple fallback options
                const uploadDate = getUploadDateBadge(
                    customer.first_uploaded_at || customer.created_at, 
                    customer.created_at
                );
                
                // Determine which date to display in the detail line
                const displayDate = customer.first_uploaded_at || customer.created_at;
                
                const callStatus = mapCallStatus(customer.call_status || 'ready');
                
                return `
                    <tr class="customer-row ${callStatus}" data-customer-id="${customer.id}">
                        <td>
                            <input type="checkbox" value="${customer.id}" 
                                   ${selectedCustomers.has(customer.id) ? 'checked' : ''}
                                   onchange="toggleCustomerSelection('${customer.id}')">
                        </td>
                        <td style="text-align: center; font-weight: 600; color: #495057;">
                            ${serialNo}
                        </td>
                        <td>
                            <span class="upload-date-badge ${uploadDate.class}">${uploadDate.text}</span>
                            <div style="font-size: 0.8em; color: #666; margin-top: 2px;">
                                ${formatDate(displayDate) || 'No date available'}
                            </div>
                        </td>
                        <td><strong>${customer.full_name || customer.name || 'Unknown'}</strong></td>
                        <td>${customer.primary_phone || customer.phone_number || 'N/A'}</td>
                        <td><code>${loan.loan_id || 'N/A'}</code></td>
                        <td>‚Çπ${formatCurrency(loan.outstanding_amount || 0)}</td>
                        <td>${formatDate(loan.next_due_date) || 'N/A'}</td>
                        <td><span class="badge">${customer.state || 'N/A'}</span></td>
                        <td>${loan.cluster || 'N/A'}</td>
                        <td>${loan.branch || 'N/A'}</td>
                        <td>${loan.branch_contact_number || 'N/A'}</td>
                        <td>${loan.employee_name || 'N/A'}</td>
                        <td>${loan.employee_id || 'N/A'}</td>
                        <td>${loan.employee_contact_number || 'N/A'}</td>
                        <td>${formatDate(loan.last_paid_date) || 'N/A'}</td>
                        <td>‚Çπ${formatCurrency(loan.last_paid_amount || 0)}</td>
                        <td>‚Çπ${formatCurrency(loan.due_amount || 0)}</td>
                        <td>
                            <span class="status-badge status-${callStatus}">
                                ${callStatus.replace('-', ' ')}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn btn-call" onclick="callCustomer('${customer.id}')">
                                üìû Call
                            </button>
                            <button class="action-btn btn-details" onclick="showCustomerDetails('${customer.id}')">
                                üëÅÔ∏è Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateDisplayInfo();
        }

        // Get upload date badge - simplified IST only logic
        function getUploadDateBadge(dateString, fallbackDate) {
            const primaryDate = dateString || fallbackDate;
            if (!primaryDate) return { class: 'date-older', text: 'Unknown' };
            
            try {
                // Parse the date (incoming from server in IST)
                const uploadDate = new Date(primaryDate);
                
                // Validate date object
                if (isNaN(uploadDate.getTime())) {
                    return { class: 'date-older', text: 'Invalid Date' };
                }
                
                // Convert current time to IST to match server timezone
                const now = new Date();
                const istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
                const utc = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
                const istNow = new Date(utc + istOffset);
                
                // Get date strings for simple comparison (both in IST now)
                const todayStr = istNow.toDateString();
                const uploadStr = uploadDate.toDateString();
                
                // Debug logging to see what's happening
                console.log('Date comparison debug:', {
                    primaryDate,
                    uploadStr,
                    todayStr,
                    uploadDate: uploadDate.toISOString(),
                    istNow: istNow.toISOString(),
                    browserTime: now.toISOString()
                });
                
                // Today check
                if (uploadStr === todayStr) {
                    return { class: 'date-today', text: 'Today' };
                }
                
                // Yesterday check
                const yesterday = new Date(istNow);
                yesterday.setDate(istNow.getDate() - 1);
                
                if (uploadStr === yesterday.toDateString()) {
                    return { class: 'date-yesterday', text: 'Yesterday' };
                }
                
                // Calculate days difference using IST dates
                const istNowDate = new Date(istNow);
                istNowDate.setHours(0,0,0,0);
                const uploadDateOnly = new Date(uploadDate);
                uploadDateOnly.setHours(0,0,0,0);
                
                const timeDiff = istNowDate.getTime() - uploadDateOnly.getTime();
                const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                
                if (daysDiff <= 7 && daysDiff > 0) {
                    return { class: 'date-week', text: `${daysDiff}d ago` };
                } else if (daysDiff < 0) {
                    // Future date
                    return { class: 'date-future', text: 'Future' };
                }
                
                return { class: 'date-older', text: `${daysDiff}d ago` };
                
            } catch (error) {
                console.error('Error in getUploadDateBadge:', error, primaryDate);
                return { class: 'date-older', text: 'Date Error' };
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN').format(amount);
        }

        // Format date - simple IST formatting
        function formatDate(dateString) {
            if (!dateString) return null;
            
            try {
                return formatDateOnlyIST(dateString);
            } catch (error) {
                console.error('Error formatting date:', error, dateString);
                return 'Date Error';
            }
        }

        // Format date and time - simple IST formatting
        function formatDateTime(dateString) {
            if (!dateString) return null;
            try {
                return formatDateIST(dateString);
            } catch (error) {
                console.error('Error formatting datetime:', error, dateString);
                return 'DateTime Error';
            }
        }

        // Get IST current time
        function getCurrentISTTime() {
            const now = new Date();
            return now.toLocaleTimeString('en-IN') + ' IST';
        }

        // Select all filtered customers
        function selectAllFilteredCustomers() {
            if (displayedCustomers.length === 0) {
                showNotification('No customers available to select', 'warning');
                return;
            }
            
            // Select all displayed customers
            displayedCustomers.forEach(customer => {
                selectedCustomers.add(customer.id);
            });
            
            updateSelectionCount();
            renderCustomerTable(); // Re-render to update checkboxes
            showNotification(`Selected all ${displayedCustomers.length} filtered customers`, 'success');
        }

        // Toggle customer selection
        function toggleCustomerSelection(customerId) {
            if (selectedCustomers.has(customerId)) {
                selectedCustomers.delete(customerId);
            } else {
                selectedCustomers.add(customerId);
            }
            updateSelectionCount();
        }

        // Update selection count
        function updateSelectionCount() {
            const count = selectedCustomers.size;
            const selectedCountEl = document.getElementById('selectedCount');
            const selectedCountTextEl = document.getElementById('selectedCountText');
            
            if (selectedCountEl) selectedCountEl.textContent = `${count} selected`;
            if (selectedCountTextEl) selectedCountTextEl.textContent = count;
            
            // Update the new selected customers info
            const selectedInfo = document.getElementById('selectedCustomersInfo');
            if (selectedInfo) {
                selectedInfo.textContent = `${count} selected`;
            }
            
            const hasSelection = count > 0;
            const callSelectedBtn = document.getElementById('callSelectedBtn');
            const updateSelectedStatusBtn = document.getElementById('updateSelectedStatusBtn');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            
            if (callSelectedBtn) callSelectedBtn.disabled = !hasSelection;
            if (updateSelectedStatusBtn) updateSelectedStatusBtn.disabled = !hasSelection;
            if (exportSelectedBtn) exportSelectedBtn.disabled = !hasSelection;
        }

        // Update display information
        function updateDisplayInfo() {
            const displayLimit = document.getElementById('customerDisplayLimit').value;
            const totalFiltered = filteredCustomers.length;
            const displayed = displayedCustomers.length;
            
            const displayInfo = document.getElementById('displayedCustomersInfo');
            if (displayInfo) {
                if (displayLimit === 'all') {
                    displayInfo.textContent = `Showing all ${displayed} customers`;
                } else {
                    displayInfo.textContent = `Showing ${displayed} of ${totalFiltered} customers`;
                }
            }
            
            updateSelectionCount();
        }

        // Select all displayed customers
        function selectAllDisplayedCustomers() {
            if (displayedCustomers.length === 0) {
                showToast('No customers available to select', 'warning');
                return;
            }

            displayedCustomers.forEach(customer => {
                selectedCustomers.add(customer.id);
            });

            // Update checkboxes in the table
            const checkboxes = document.querySelectorAll('#customerTableBody input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
            });

            updateSelectionCount();
            showToast(`Selected all ${displayedCustomers.length} displayed customers`, 'success');
        }

        // Deselect all customers
        function deselectAllCustomers() {
            selectedCustomers.clear();

            // Update checkboxes in the table
            const checkboxes = document.querySelectorAll('#customerTableBody input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });

            // Update select all checkbox
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }

            updateSelectionCount();
            showToast('Deselected all customers', 'info');
        }

        // Update statistics with IST timezone
        function updateStatistics() {
            const totalCustomers = customers.length;
            
            // Calculate today's uploads using IST timezone
            const istToday = new Date().toLocaleDateString('en-IN', {timeZone: 'Asia/Kolkata'});
            const todayUploads = customers.filter(c => {
                const uploadDate = new Date(c.first_uploaded_at).toLocaleDateString('en-IN', {timeZone: 'Asia/Kolkata'});
                return uploadDate === istToday;
            }).length;
            
            const statusCounts = customers.reduce((acc, customer) => {
                const status = mapCallStatus(customer.call_status || 'ready');
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            document.getElementById('totalCustomersStat').textContent = totalCustomers;
            document.getElementById('todayUploadsStat').textContent = todayUploads;
            document.getElementById('readyToCallStat').textContent = statusCounts.ready || 0;
            document.getElementById('activeCallsStat').textContent = statusCounts['in-progress'] || 0;
            document.getElementById('completedCallsStat').textContent = statusCounts.completed || 0;
            document.getElementById('totalCustomersDisplay').textContent = `Total: ${totalCustomers}`;
        }

        // Handle file upload
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showUploadProgress(true);
                logActivity(`Uploading file: ${file.name}`);

                const response = await fetch('/api/upload-customers', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    // Enhanced upload tracking with detailed statistics
                    const stats = result.processing_results;
                    const totalRecords = stats.total_records || 0;
                    const successRecords = stats.success_records || 0;
                    const failedRecords = stats.failed_records || 0;
                    const newRecords = stats.new_customers || 0;
                    const updatedRecords = stats.updated_customers || 0;
                    
                    const successMessage = `Upload completed: ${successRecords}/${totalRecords} records processed successfully`;
                    logActivity(`‚úÖ ${successMessage}`);
                    
                    // Show detailed upload statistics
                    let detailMessage = `üìä Upload Statistics:\n`;
                    detailMessage += `‚Ä¢ Total Records: ${totalRecords}\n`;
                    detailMessage += `‚Ä¢ Successfully Processed: ${successRecords}\n`;
                    if (newRecords > 0) detailMessage += `‚Ä¢ New Customers: ${newRecords}\n`;
                    if (updatedRecords > 0) detailMessage += `‚Ä¢ Updated Customers: ${updatedRecords}\n`;
                    if (failedRecords > 0) detailMessage += `‚Ä¢ Failed Records: ${failedRecords}\n`;
                    
                    logActivity(detailMessage);
                    showToast(successMessage, 'success');
                    
                    // Show upload tracking info to prevent duplicate file uploads
                    const uploadId = result.upload_id || 'unknown';
                    logActivity(`üìÇ File Upload ID: ${uploadId} - Use this to track your upload`);
                    
                    // Refresh customer data from database after successful upload
                    setTimeout(() => {
                        logActivity('üîÑ Refreshing customer data after upload...');
                        loadCustomerData(true);
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                logActivity(`Upload failed: ${error.message}`, 'error');
                alert(`Upload failed: ${error.message}`);
            } finally {
                showUploadProgress(false);
                fileInput.value = '';
            }
        }

        // Call customer with enhanced error handling and status updates
        async function callCustomer(customerId) {
            try {
                const customer = customers.find(c => c.id === customerId);
                if (!customer) {
                    alert('Customer not found');
                    return;
                }

                logActivity(`Initiating call for ${customer.name || 'Unknown'} (${customer.phone_number || 'N/A'})`);
                
                // Disable the call button for this customer to prevent double calls
                const callBtn = document.querySelector(`button[onclick="callCustomer('${customerId}')"]`);
                if (callBtn) {
                    callBtn.disabled = true;
                    callBtn.textContent = 'üìû Calling...';
                }

                const response = await fetch('/api/trigger-single-call', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ customer_id: customerId })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    logActivity(`‚úÖ Call initiated successfully for ${customer.name || 'Unknown'}`);
                    // Update customer status in the UI
                    updateCustomerCallStatus(customerId, 'calling', 'Call initiated');
                    
                    // Show success toast notification
                    showToast(`Call started for ${customer.name || 'Unknown'}`, 'success');
                } else {
                    throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Call error:', error);
                logActivity(`‚ùå Call failed: ${error.message}`, 'error');
                alert(`Call failed: ${error.message}`);
                
                // Re-enable the call button on error
                const callBtn = document.querySelector(`button[onclick="callCustomer('${customerId}')"]`);
                if (callBtn) {
                    callBtn.disabled = false;
                    callBtn.textContent = 'üìû Call';
                }
            }
        }

        // Call selected customers with enhanced progress tracking
        async function callSelectedCustomers() {
            if (selectedCustomers.size === 0) {
                alert('Please select customers to call');
                return;
            }
            
            const customerCount = selectedCustomers.size;
            const selectedCustomerNames = Array.from(selectedCustomers).map(id => {
                const customer = customers.find(c => c.id === id);
                return customer ? customer.name : `ID: ${id}`;
            }).slice(0, 3).join(', ');
            
            const confirmMessage = customerCount <= 3 
                ? `Call ${customerCount} selected customers: ${selectedCustomerNames}?`
                : `Call ${customerCount} selected customers: ${selectedCustomerNames} and ${customerCount - 3} more?`;
            
            if (!confirm(confirmMessage)) return;
            
            try {
                logActivity(`üöÄ Initiating bulk calls for ${customerCount} customers`);
                
                // Disable bulk call button during processing
                const bulkBtn = document.getElementById('callSelectedBtn');
                const originalText = bulkBtn.textContent;
                bulkBtn.disabled = true;
                bulkBtn.textContent = `üìû Calling ${customerCount} customers...`;

                const response = await fetch('/api/trigger-bulk-calls', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ customer_ids: Array.from(selectedCustomers) })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    logActivity(`‚úÖ Bulk calls initiated successfully for ${customerCount} customers`);
                    
                    // Update status for all selected customers
                    selectedCustomers.forEach(customerId => {
                        updateCustomerCallStatus(customerId, 'calling', 'Bulk call initiated');
                    });
                    
                    // Show success notification
                    showToast(`Bulk calls started for ${customerCount} customers`, 'success');
                    
                    // Clear selection
                    selectedCustomers.clear();
                    updateSelectionCount();
                    document.getElementById('selectAll').checked = false;
                } else {
                    throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Bulk call error:', error);
                logActivity(`‚ùå Bulk calls failed: ${error.message}`, 'error');
                alert(`Bulk calls failed: ${error.message}`);
            } finally {
                // Re-enable bulk call button
                const bulkBtn = document.getElementById('callSelectedBtn');
                bulkBtn.disabled = selectedCustomers.size === 0;
                bulkBtn.textContent = originalText;
            }
        }

        // Update selected customers status
        async function updateSelectedStatus() {
            if (selectedCustomers.size === 0) {
                alert('Please select customers to update status');
                return;
            }
            
            const newStatus = prompt('Enter new status (ready, calling, completed, failed):');
            if (!newStatus) return;
            
            const validStatuses = ['ready', 'calling', 'completed', 'failed'];
            if (!validStatuses.includes(newStatus.toLowerCase())) {
                alert('Invalid status. Please use: ready, calling, completed, or failed');
                return;
            }
            
            const customerCount = selectedCustomers.size;
            if (!confirm(`Update status to "${newStatus}" for ${customerCount} selected customers?`)) return;
            
            try {
                logActivity(`üîÑ Updating status for ${customerCount} customers to "${newStatus}"`);
                
                const bulkBtn = document.getElementById('updateSelectedStatusBtn');
                const originalText = bulkBtn.textContent;
                bulkBtn.disabled = true;
                bulkBtn.textContent = `Updating ${customerCount} customers...`;

                const response = await fetch('/api/update-bulk-status', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        customer_ids: Array.from(selectedCustomers),
                        status: newStatus.toLowerCase()
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    logActivity(`‚úÖ Status updated successfully for ${customerCount} customers`);
                    
                    // Update status for all selected customers in the local data
                    selectedCustomers.forEach(customerId => {
                        updateCustomerCallStatus(customerId, newStatus.toLowerCase(), `Status updated to ${newStatus}`);
                    });
                    
                    // Refresh customer data to reflect changes
                    await loadCustomerData(true);
                    
                    showToast(`Status updated for ${customerCount} customers`, 'success');
                    
                    // Clear selection
                    selectedCustomers.clear();
                    updateSelectionCount();
                    document.getElementById('selectAll').checked = false;
                } else {
                    throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Bulk status update error:', error);
                logActivity(`‚ùå Status update failed: ${error.message}`, 'error');
                alert(`Status update failed: ${error.message}`);
            } finally {
                const bulkBtn = document.getElementById('updateSelectedStatusBtn');
                bulkBtn.disabled = selectedCustomers.size === 0;
                bulkBtn.textContent = originalText;
            }
        }

        // Show customer details
        function showCustomerDetails(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const modalContent = document.getElementById('customerDetailsContent');
            modalContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h4>üë§ Customer Information</h4>
                        <p><strong>Name:</strong> ${customer.name || 'Unknown'}</p>
                        <p><strong>Phone:</strong> ${customer.phone_number || 'N/A'}</p>
                        <p><strong>State:</strong> ${customer.state || 'N/A'}</p>
                        <p><strong>Email:</strong> ${customer.email || 'N/A'}</p>
                        <p><strong>First Uploaded:</strong> ${formatDate(customer.first_uploaded_at)}</p>
                        <p><strong>Last Contact:</strong> ${formatDate(customer.last_contact_date) || 'Never'}</p>
                    </div>
                    <div>
                        <h4>üí∞ Loan Information</h4>
                        ${customer.loans.map(loan => `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 6px;">
                                <p><strong>Loan ID:</strong> ${loan.loan_id}</p>
                                <p><strong>Outstanding:</strong> ‚Çπ${formatCurrency(loan.outstanding_amount)}</p>
                                <p><strong>Due Amount:</strong> ‚Çπ${formatCurrency(loan.due_amount)}</p>
                                <p><strong>Next Due:</strong> ${formatDate(loan.next_due_date) || 'N/A'}</p>
                                <p><strong>Last Paid:</strong> ‚Çπ${formatCurrency(loan.last_paid_amount)} on ${formatDate(loan.last_paid_date) || 'N/A'}</p>
                                <p><strong>Cluster:</strong> ${loan.cluster || 'N/A'}</p>
                                <p><strong>Branch:</strong> ${loan.branch || 'N/A'}</p>
                                <p><strong>Employee:</strong> ${loan.employee_name || 'N/A'} (${loan.employee_id || 'N/A'})</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('customerModal').style.display = 'flex';
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('uploadDateFilter').value = '';
            document.getElementById('callStatusFilter').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('clusterFilter').value = '';
            document.getElementById('branchFilter').value = '';
            document.getElementById('employeeFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('customDateRange').style.display = 'none';
            
            applyFilters();
        }

        // Export selected customers
        function exportSelectedCustomers() {
            if (selectedCustomers.size === 0) return;
            
            const selectedData = customers.filter(c => selectedCustomers.has(c.id));
            const csvContent = convertToCSV(selectedData);
            downloadCSV(csvContent, `exported_customers_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Convert to CSV
        function convertToCSV(data) {
            const headers = [
                'Name', 'Phone', 'State', 'Loan ID', 'Outstanding Amount', 'Due Amount',
                'Next Due Date', 'Last Paid Date', 'Last Paid Amount', 'Cluster',
                'Branch', 'Branch Contact', 'Employee', 'Employee ID', 'Employee Contact',
                'Upload Date', 'Call Status'
            ];
            
            const rows = data.map(customer => {
                const loan = customer.loans[0] || {};
                return [
                    customer.name || 'Unknown',
                    customer.phone_number || 'N/A',
                    customer.state || '',
                    loan.loan_id || '',
                    loan.outstanding_amount || 0,
                    loan.due_amount || 0,
                    loan.next_due_date || '',
                    loan.last_paid_date || '',
                    loan.last_paid_amount || 0,
                    loan.cluster || '',
                    loan.branch || '',
                    loan.branch_contact_number || '',
                    loan.employee_name || '',
                    loan.employee_id || '',
                    loan.employee_contact_number || '',
                    customer.first_uploaded_at,
                    customer.call_status || 'ready'
                ];
            });
            
            return [headers, ...rows].map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        }

        // Download CSV
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Utility functions
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;
            statusEl.textContent = status === 'connected' ? 'üü¢ Connected' : 
                                  status === 'error' ? 'üî¥ Error' : 'üü° Connecting...';
        }

        // Global loading functions
        function showGlobalLoading(title = 'Loading...', subtitle = '') {
            const overlay = document.getElementById('globalLoadingOverlay');
            const titleEl = document.getElementById('loadingText');
            const subtitleEl = document.getElementById('loadingSubtext');
            
            if (overlay) {
                titleEl.textContent = title;
                subtitleEl.textContent = subtitle;
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';
            }
        }

        function hideGlobalLoading() {
            const overlay = document.getElementById('globalLoadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        function updateLoadingText(title, subtitle = '') {
            const titleEl = document.getElementById('loadingText');
            const subtitleEl = document.getElementById('loadingSubtext');
            
            if (titleEl) titleEl.textContent = title;
            if (subtitleEl) subtitleEl.textContent = subtitle;
        }

        // Setup hot reloading functionality
        function setupHotReloading() {
            console.log('üî• Setting up hot data reloading...');
            
            // Auto-refresh customer data every minute
            if (dataRefreshInterval) {
                clearInterval(dataRefreshInterval);
            }
            
            dataRefreshInterval = setInterval(async () => {
                try {
                    console.log('üîÑ Auto-refreshing customer data...');
                    await loadCustomerData(false, false);
                    
                    // Also refresh call statuses
                    await loadCallStatuses();
                    
                } catch (error) {
                    console.error('Auto-refresh failed:', error);
                }
            }, DATA_REFRESH_INTERVAL);
            
            // Show notification about auto-refresh
            showToast('Auto-refresh enabled: Data will update every minute', 'info', 4000);
        }

        function showLoading(show) {
            const tbody = document.getElementById('customerTableBody');
            if (show) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="19" style="text-align: center; padding: 40px; color: #666;">
                            <div class="loading"></div>
                            <div style="margin-top: 10px;">Loading customer data...</div>
                        </td>
                    </tr>
                `;
            }
        }

        function showUploadProgress(show) {
            const progressEl = document.getElementById('uploadProgress');
            const statusEl = document.getElementById('uploadStatus');
            
            if (show) {
                progressEl.style.display = 'block';
                statusEl.innerHTML = '<div class="loading"></div> Uploading file...';
            } else {
                progressEl.style.display = 'none';
            }
        }

        function updateUploadProgress(progress, message) {
            const progressBar = document.getElementById('progressBar');
            const statusEl = document.getElementById('uploadStatus');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            if (statusEl && message) {
                statusEl.textContent = message;
            }
        }

        function logActivity(message, type = 'info') {
            const timestamp = getCurrentISTTime();
            const logEntry = document.createElement('div');
            logEntry.style.cssText = `
                padding: 8px; margin: 5px 0; border-radius: 4px; font-size: 0.9em;
                background: ${type === 'error' ? '#fee' : '#f8f9fa'};
                color: ${type === 'error' ? '#c33' : '#333'};
                border-left: 3px solid ${type === 'error' ? '#dc3545' : '#667eea'};
            `;
            logEntry.innerHTML = `<strong>${timestamp} IST</strong> ${message}`;
            
            const activityLog = document.getElementById('activityLog');
            if (activityLog) {
                activityLog.insertBefore(logEntry, activityLog.firstChild);
                
                // Keep only last 50 entries
                while (activityLog.children.length > 50) {
                    activityLog.removeChild(activityLog.lastChild);
                }
            } else {
                // Fallback to console if element doesn't exist yet
                console.log(`${timestamp} IST - ${message}`);
            }
        }

        // Show toast notification
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, duration);
        }

        function setupAutoRefresh() {
            // Update status every 30 seconds
            refreshInterval = setInterval(function() {
                const refreshCount = parseInt(document.getElementById('statusRefreshCount').textContent.split(': ')[1] || '0');
                document.getElementById('statusRefreshCount').textContent = `Refreshes: ${refreshCount + 1}`;
                
                // Auto-refresh customer data every 5 minutes (300 seconds)
                if (refreshCount > 0 && refreshCount % 10 === 0) {
                    logActivity('üîÑ Auto-refreshing customer data from database...');
                    loadCustomerData(false); // Silent refresh
                    
                    // Also refresh batch data every 5 minutes
                    loadBatchDetails();
                } else {
                    // Just update statistics and timestamp
                    document.getElementById('lastStatusUpdate').textContent = `Last update: ${getCurrentISTTime()} IST`;
                    updateStatistics();
                }
            }, 30000);
            
            // Initial data load
            logActivity('üöÄ Starting initial data load from database...');
        }

        // Update customer call status
        function updateCustomerCallStatus(customerId, status, message) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                customer.call_status = status;
                renderCustomerTable();
                updateStatistics();
                logActivity(`Customer ${customer.name || 'Unknown'}: ${message || status}`);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            console.log('üßπ Cleaning up dashboard resources...');
            if (refreshInterval) clearInterval(refreshInterval);
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (dataRefreshInterval) clearInterval(dataRefreshInterval);
            if (ws) ws.close();
        });

        // Handle page visibility changes for better performance
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, pause auto-refresh
                console.log('üì¥ Page hidden, pausing auto-refresh');
                if (dataRefreshInterval) {
                    clearInterval(dataRefreshInterval);
                    dataRefreshInterval = null;
                }
            } else {
                // Page is visible again, resume auto-refresh
                console.log('üëÅÔ∏è Page visible, resuming auto-refresh');
                setupHotReloading();
            }
        });
    </script>
</body>
</html>
